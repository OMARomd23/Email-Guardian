<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Guardian - Secure Multi-User Email Analysis</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    
    <style>
        :root {
            --primary: #3b82f6;
            --cyber: #14b8a6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1a1a1a;
            --light: #ffffff;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
             
            /* Theme variables */
            --bg-primary: var(--light);
            --bg-secondary: var(--gray-100);
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-600);
            --border-color: var(--gray-200);
            --card-bg: var(--light);
        }

        [data-theme="dark"] {
            --bg-primary: var(--gray-900);
            --bg-secondary: var(--gray-800);
            --text-primary: var(--light);
            --text-secondary: var(--gray-300);
            --border-color: var(--gray-700);
            --card-bg: var(--gray-800);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            min-height: 100vh;
        }

        /* Authentication Modal Styles */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .auth-modal {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            margin: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .auth-input {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--card-bg);
        }

        .auth-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .auth-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auth-btn-primary {
            background: var(--primary);
            color: white;
        }

        .auth-btn-primary:hover:not(:disabled) {
            background: var(--cyber);
            transform: translateY(-1px);
        }

        .auth-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .auth-btn-secondary:hover:not(:disabled) {
            background: var(--border-color);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-message {
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-top: 1rem;
            display: none;
        }

        .auth-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .auth-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        /* Header */
        .header {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .logo svg {
            width: 32px;
            height: 32px;
        }

        .nav-tabs {
            display: flex;
            gap: 2rem;
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .nav-tab:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            background: var(--bg-secondary);
            font-size: 0.875rem;
        }

        .user-email {
            color: var(--text-primary);
            font-weight: 500;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-indicator.online {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-indicator.offline {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Main Content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Scanner Tab */
        .scanner-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
        }

        .email-input-section {
            grid-column: 1;
        }

        .options-panel {
            grid-column: 2;
        }

        .results-section {
            grid-column: 1 / -1;
            margin-top: 2rem;
        }

        .email-textarea {
            width: 100%;
            min-height: 300px;
            padding: 1rem;
            border: 2px dashed var(--border-color);
            border-radius: 0.75rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Inter', monospace;
            font-size: 0.875rem;
            resize: vertical;
            transition: all 0.2s ease;
        }

        .email-textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--card-bg);
        }

        .email-textarea.drag-over {
            border-color: var(--cyber);
            background: rgba(20, 184, 166, 0.05);
        }

        .char-counter {
            text-align: right;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .file-upload {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            text-align: center;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-upload:hover {
            background: var(--primary);
            color: white;
        }

        .file-input {
            display: none;
        }

        /* Options Panel */
        .option-group {
            margin-bottom: 1.5rem;
        }

        .option-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-400);
            transition: 0.3s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .scan-button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--cyber));
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .scan-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .scan-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .scan-button.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Results Display */
        .results-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 2rem;
            margin-top: 2rem;
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .classification-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .badge-legitimate {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .badge-spam {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .badge-phishing {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .confidence-display {
            margin-bottom: 1.5rem;
        }

        .confidence-display .confidence-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .confidence-display .confidence-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-display .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            border-radius: 4px;
            transition: width 0.8s ease;
            animation: fillBar 0.8s ease;
        }

        @keyframes fillBar {
            from { width: 0%; }
        }

        .probability-breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .probability-item {
            text-align: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 0.5rem;
        }

        .probability-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .probability-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .explanation {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .result-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background: var(--card-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--cyber);
            border-color: var(--cyber);
        }

        /* History Tab */
        .history-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .filter-select {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .history-list {
            space-y: 1rem;
        }

        .history-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .history-date {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .history-preview {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            max-height: 3em;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-details {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .history-item.expanded .history-details {
            display: block;
        }

        /* Stats Tab Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 4px solid;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .metric-card.total { border-left-color: var(--primary); }
        .metric-card.legitimate { border-left-color: var(--success); }
        .metric-card.spam { border-left-color: var(--warning); }
        .metric-card.phishing { border-left-color: var(--danger); }
        .metric-card.period { border-left-color: var(--cyber); }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            text-align: center;
        }

        .activity-chart {
            grid-column: 1 / -1;
        }

        .confidence-chart {
            grid-column: 1 / -1;
        }

        .confidence-bar-item {
            margin-bottom: 1rem;
        }

        .confidence-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .confidence-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease;
        }

        .stats-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .stats-period-select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .refresh-stats {
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .refresh-stats:hover {
            background: var(--cyber);
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .stats-loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        /* Settings Tab */
        .settings-grid {
            display: grid;
            gap: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .test-connection {
            margin-top: 1rem;
        }

        .system-status {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 4.7s forwards;
            min-width: 300px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--primary); }

        .toast-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            opacity: 0.8;
        }

        .toast-close:hover {
            opacity: 1;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(100%); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .nav-tabs {
                gap: 1rem;
                overflow-x: auto;
            }

            .container {
                padding: 1rem;
            }

            .scanner-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .options-panel {
                grid-column: 1;
            }

            .results-section {
                grid-column: 1;
            }

            .probability-breakdown {
                grid-template-columns: 1fr;
            }

            .history-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .toast {
                min-width: auto;
                margin: 0 1rem;
            }

            .auth-modal {
                margin: 1rem;
            }
        }

        /* Loading States */
        .loading-skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--border-color) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 0.25rem;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .visible { display: block !important; }
        .text-center { text-align: center; }
        .mt-4 { margin-top: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .p-4 { padding: 1rem; }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <div class="auth-header">
                <div class="auth-title">üõ°Ô∏è Email Guardian</div>
               
            </div>
            
            <form class="auth-form" id="authForm">
                <input 
                    type="url"
                    class="auth-input"
                    id="authApiUrl"
                    placeholder="API URL (e.g. https://lively-vibrancy-production.up.railway.app)"
                    required
                    autocomplete="off"
                >
                <input 
                    type="email" 
                    class="auth-input" 
                    id="authEmail" 
                    placeholder="Enter your email"
                    required
                    autocomplete="email"
                >
                <input 
                    type="password" 
                    class="auth-input" 
                    id="authPassword" 
                    placeholder="Enter your password (min 6 characters)"
                    required
                    autocomplete="current-password"
                >
                
                <div class="auth-buttons">
                    <button type="button" class="auth-btn auth-btn-secondary" id="loginBtn">
                        Login
                    </button>
                    <button type="button" class="auth-btn auth-btn-primary" id="registerBtn">
                        Register
                    </button>
                </div>
            </form>
            
            <div id="authMessage" class="auth-message"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="header" id="mainHeader" style="display: none;">
        <div class="header-content">
            <div class="logo">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Email Guardian
            </div>
            
            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="scanner" onclick="switchTab('scanner')">Scanner</button>
                <button class="nav-tab" data-tab="stats" onclick="switchTab('stats')">Analytics</button>
                <button class="nav-tab" data-tab="history" onclick="switchTab('history')">History</button>
                <button class="nav-tab" data-tab="settings" onclick="switchTab('settings')">Settings</button>
            </nav>
            
            <div class="header-controls">
                <div class="user-info" id="userInfo">
                    <span class="user-email" id="userEmail"></span>
                    <button class="logout-btn" id="logoutBtn" title="Logout" onclick="handleLogout()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 21H5A2 2 0 0 1 3 19V5A2 2 0 0 1 5 3H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <polyline points="16,17 21,12 16,7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="21" y1="12" x2="9" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                
                <div class="status-indicator" id="apiStatus">
                    <span class="status-dot"></span>
                    <span class="status-text">Connecting...</span>
                </div>
                
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container" id="mainContent" style="display: none;">
        <!-- Scanner Tab -->
        <div id="scanner" class="tab-content active">
            <div class="scanner-grid">
                <!-- Email Input Section -->
                <div class="email-input-section">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Email Scanner</h2>
                        </div>
                        
                        <textarea 
                            id="emailInput" 
                            class="email-textarea" 
                            placeholder="Paste your email content here or drag and drop an .eml/.txt file..."
                            oninput="updateCharCount()"
                            ondragover="handleDragOver(event)"
                            ondragleave="handleDragLeave(event)"
                            ondrop="handleFileDrop(event)">
                        </textarea>
                        
                        <div class="char-counter">
                            <span id="charCount">0</span> characters
                        </div>
                        
                        <div class="file-upload" id="fileUpload" onclick="document.getElementById('fileInput').click()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <polyline points="17,8 12,3 7,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Upload Email File (.txt, .eml)
                            <input type="file" id="fileInput" class="file-input" accept=".txt,.eml,.msg" onchange="handleFileSelect(event)">
                        </div>
                    </div>
                </div>
                
                <!-- Options Panel -->
                <div class="options-panel">
                    <div class="card">
                        <h3 class="card-title">Scan Options</h3>
                        
                        <div class="option-group">
                            <label class="option-label">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="llmValidation" checked>
                                    <span class="slider"></span>
                                </label>
                                Enable LLM Validation
                            </label>
                        </div>
                        
                        <button id="scanButton" class="scan-button" onclick="scanEmail()">
                            <span class="button-text">Scan Email</span>
                        </button>
                        
                        <div class="mt-4">
                            <h4 style="margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Quick Tests:</h4>
                            <button class="btn" onclick="loadExample('legitimate')" style="width: 100%; margin-bottom: 0.5rem;">Legitimate Email</button>
                            <button class="btn" onclick="loadExample('spam')" style="width: 100%; margin-bottom: 0.5rem;">Spam Example</button>
                            <button class="btn" onclick="loadExample('phishing')" style="width: 100%;">Phishing Example</button>
                        </div>
                    </div>
                </div>
                
                <!-- Results Section -->
                <div class="results-section" id="resultsSection" style="display: none;">
                    <div class="results-card">
                        <div class="card-header">
                            <h3 class="card-title">Scan Results</h3>
                            <div class="result-actions">
                                <button class="btn" onclick="copyResults()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M5 15H4A2 2 0 0 1 2 13V4A2 2 0 0 1 4 2H13A2 2 0 0 1 15 4V5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Copy
                                </button>
                                <button class="btn" onclick="exportResults()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 15V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <polyline points="7,10 12,15 17,10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Export
                                </button>
                            </div>
                        </div>
                        
                        <div id="resultsContent">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Tab -->
        <div id="stats" class="tab-content">
            <div class="stats-controls">
                <select class="stats-period-select" id="statsPeriod" onchange="loadStats()">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
                <button class="refresh-stats" onclick="loadStats()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <polyline points="23,4 23,10 17,10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <polyline points="1,20 1,14 7,14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Refresh
                </button>
            </div>

            <div id="statsContent">
                <div class="stats-loading">
                    <div>Loading analytics...</div>
                </div>
            </div>
        </div>
        
        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Scan History</h2>
                    <button class="btn" onclick="exportHistory()">Export History</button>
                </div>
                
                <div class="history-controls">
                    <input type="text" class="search-input" id="historySearch" placeholder="Search history..." oninput="filterHistory()">
                    <select class="filter-select" id="historyFilter" onchange="filterHistory()">
                        <option value="all">All Results</option>
                        <option value="legitimate">Legitimate</option>
                        <option value="spam">Spam</option>
                        <option value="phishing">Phishing</option>
                    </select>
                    <button class="btn" onclick="clearHistory()">Clear All</button>
                </div>
                
                <div id="historyList" class="history-list">
                    <!-- History items will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="settings-grid">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">API Configuration</h2>
                        <button class="btn test-connection" onclick="testConnection()">Test Connection</button>
                    </div>
                    
                    <form id="settingsForm" onsubmit="saveSettings(event)">
                        <div class="form-group">
                            <label class="form-label" for="apiUrl">API URL</label>
                            <input type="url" class="form-input" id="apiUrl" placeholder="https://lively-vibrancy-production.up.railway.app" required>
                            <div class="form-help">Enter the base URL of your Email Guardian API</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Current User</label>
                            <input type="text" class="form-input" id="currentUser" readonly>
                            <div class="form-help">Your authenticated email address</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <input type="text" class="form-input" id="currentApiKey" readonly>
                            <div class="form-help">Your personal API key (automatically managed)</div>
                        </div>
                        
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">Save Settings</button>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">System Status</h2>
                    </div>
                    
                    <div class="system-status">
                        <div class="status-grid">
                            <div class="status-item">
                                <span>API Connection</span>
                                <span id="apiConnectionStatus" class="status-indicator offline">
                                    <span class="status-dot"></span>
                                    Offline
                                </span>
                            </div>
                            <div class="status-item">
                                <span>Model Status</span>
                                <span id="modelStatus" class="status-indicator offline">
                                    <span class="status-dot"></span>
                                    Unknown
                                </span>
                            </div>
                            <div class="status-item">
                                <span>LLM Service</span>
                                <span id="llmStatus" class="status-indicator offline">
                                    <span class="status-dot"></span>
                                    Unknown
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="systemStats"></div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">About</h2>
                    </div>
                    
                    <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                        Email Guardian is an advanced email security scanner that uses machine learning 
                        and AI to detect spam, phishing, and other malicious emails with secure multi-user support.
                    </p>
                    
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                        <strong>Version:</strong> 2.0.0<br>
                        <strong>Build:</strong> Secure Multi-User Frontend<br>
                        <strong>Authentication:</strong> Enabled<br>
                        <strong>Data Isolation:</strong> Per-User<br>
                        <strong>License:</strong> MIT
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        // Application State
        const AppState = {
            currentTab: 'scanner',
            apiUrl: localStorage.getItem('apiUrl') || 'https://lively-vibrancy-production.up.railway.app',
            apiKey: localStorage.getItem('apiKey') || '',
            userEmail: localStorage.getItem('userEmail') || '',
            theme: localStorage.getItem('theme') || 'light',
            history: [], // Will be loaded from server
            isScanning: false,
            lastResults: null,
            statsData: null,
            isAuthenticated: false
        };

        // Color scheme for charts
        const colors = {
            legitimate: '#10b981',
            spam: '#f59e0b',
            phishing: '#ef4444',
            primary: '#3b82f6',
            secondary: '#14b8a6'
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('loginBtn').addEventListener('click', handleLogin);
    document.getElementById('registerBtn').addEventListener('click', handleRegister);
    initializeApp();
});

        function initializeApp() {
            document.documentElement.setAttribute('data-theme', AppState.theme);

            // Always show auth modal if no API URL or API key
            if (!AppState.apiUrl) {
                showAuthModal();
                return;
            }

            if (AppState.apiKey && AppState.userEmail) {
                validateStoredSession();
            } else {
                showAuthModal();
            }
        }

        async function validateStoredSession() {
            try {
                // Test stored API key
                const response = await makeSecureRequest('/health');
                if (response.status === 200) {
                    showMainApp();
                } else {
                    throw new Error('Invalid session');
                }
            } catch (error) {
                console.log('Stored session invalid, showing auth modal');
                clearStoredCredentials();
                showAuthModal();
            }
        }

        function clearStoredCredentials() {
            AppState.apiKey = '';
            AppState.userEmail = '';
            localStorage.removeItem('apiKey');
            localStorage.removeItem('userEmail');
        }

        function showAuthModal() {
            document.getElementById('authOverlay').style.display = 'flex';
            document.getElementById('mainHeader').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            AppState.isAuthenticated = false;

            // Pre-fill API URL input
            document.getElementById('authApiUrl').value = AppState.apiUrl || '';
        }

        function showMainApp() {
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('mainHeader').style.display = 'block';
            document.getElementById('mainContent').style.display = 'block';
            AppState.isAuthenticated = true;
            
            // Update UI with user info
            document.getElementById('userEmail').textContent = AppState.userEmail;
            document.getElementById('currentUser').value = AppState.userEmail;
            document.getElementById('currentApiKey').value = AppState.apiKey ? AppState.apiKey.substring(0, 8) + '...' : '';
            document.getElementById('apiUrl').value = AppState.apiUrl;
            
            // Check API status and load data
            checkApiStatus();
            if (AppState.currentTab === 'history') loadHistory();
            if (AppState.currentTab === 'stats') loadStats();
            
            showToast('Welcome back to Email Guardian!', 'info');
        }

        // Authentication Functions
        async function handleLogin() {
    const apiUrl = document.getElementById('authApiUrl').value.trim();
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;

    if (!apiUrl) {
        showAuthMessage('Please enter the API URL', 'error');
        return;
    }
    if (!email || !password) {
        showAuthMessage('Please enter both email and password', 'error');
        return;
    }

    AppState.apiUrl = apiUrl;
    localStorage.setItem('apiUrl', apiUrl);

    setAuthLoading(true);

    try {
        const response = await axios.post(`${AppState.apiUrl}/api/login`, {
            email: email,
            password: password
        });

        if (response.data.success) {
            AppState.apiKey = response.data.api_key;
            AppState.userEmail = response.data.email;

            localStorage.setItem('apiKey', AppState.apiKey);
            localStorage.setItem('userEmail', AppState.userEmail);

            showAuthMessage('Login successful!', 'success');

            setTimeout(() => {
                showMainApp();
            }, 1000);
        } else {
            showAuthMessage(response.data.error || 'Login failed', 'error');
        }

    } catch (error) {
        let errorMessage = 'Login failed';
        if (error.response?.data?.error) {
            errorMessage = error.response.data.error;
        } else if (error.request) {
            errorMessage = 'Cannot connect to server. Please check API URL and connection.';
        }
        showAuthMessage(errorMessage, 'error');
    } finally {
        setAuthLoading(false);
    }
}

async function handleRegister() {
    const apiUrl = document.getElementById('authApiUrl').value.trim();
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;

    if (!apiUrl) {
        showAuthMessage('Please enter the API URL', 'error');
        return;
    }
    if (!email || !password) {
        showAuthMessage('Please enter both email and password', 'error');
        return;
    }
    if (password.length < 6) {
        showAuthMessage('Password must be at least 6 characters long', 'error');
        return;
    }

    AppState.apiUrl = apiUrl;
    localStorage.setItem('apiUrl', apiUrl);

    setAuthLoading(true);

    try {
        const response = await axios.post(`${AppState.apiUrl}/api/register`, {
            email: email,
            password: password
        });

        if (response.data.success) {
            AppState.apiKey = response.data.api_key;
            AppState.userEmail = response.data.email;

            localStorage.setItem('apiKey', AppState.apiKey);
            localStorage.setItem('userEmail', AppState.userEmail);

            showAuthMessage('Registration successful!', 'success');

            setTimeout(() => {
                showMainApp();
            }, 1000);
        } else {
            showAuthMessage(response.data.error || 'Registration failed', 'error');
        }

    } catch (error) {
        let errorMessage = 'Registration failed';
        if (error.response?.data?.error) {
            errorMessage = error.response.data.error;
        } else if (error.request) {
            errorMessage = 'Cannot connect to server. Please check API URL and connection.';
        }
        showAuthMessage(errorMessage, 'error');
    } finally {
        setAuthLoading(false);
    }
}
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                clearStoredCredentials();
                AppState.history = [];
                AppState.lastResults = null;
                AppState.statsData = null;
                
                // Clear auth form
                document.getElementById('authEmail').value = '';
                document.getElementById('authPassword').value = '';
                
                showAuthModal();
                showToast('Logged out successfully', 'info');
            }
        }

        function setAuthLoading(loading) {
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            
            loginBtn.disabled = loading;
            registerBtn.disabled = loading;
            
            if (loading) {
                loginBtn.textContent = 'Logging in...';
                registerBtn.textContent = 'Registering...';
            } else {
                loginBtn.textContent = 'Login';
                registerBtn.textContent = 'Register';
            }
        }

        function showAuthMessage(message, type) {
            const messageEl = document.getElementById('authMessage');
            messageEl.textContent = message;
            messageEl.className = `auth-message auth-${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        // Secure API Request Function
        async function makeSecureRequest(url, options = {}) {
            if (!AppState.apiKey) {
                throw new Error('Not authenticated');
            }
            
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${AppState.apiKey}`,
                ...options.headers
            };
            
            const response = await axios({
                url: `${AppState.apiUrl}${url}`,
                headers: headers,
                timeout: 30000,
                ...options
            });

            // Handle auth errors
            if (response.status === 401) {
                showToast('Session expired. Please login again.', 'error');
                clearStoredCredentials();
                showAuthModal();
                throw new Error('Authentication expired');
            }

            return response;
        }

        // Tab Management
        function switchTab(tabName) {
            if (!AppState.isAuthenticated) {
                showToast('Please login first', 'warning');
                return;
            }
            
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            AppState.currentTab = tabName;
            
            // Load tab-specific data
            if (tabName === 'stats') {
                loadStats();
            } else if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'settings') {
                checkApiStatus();
            }
        }

        // Email Scanning
        async function scanEmail() {
            if (!AppState.isAuthenticated) {
                showToast('Please login first', 'warning');
                return;
            }
            
            const emailContent = document.getElementById('emailInput').value.trim();
            
            if (!emailContent) {
                showToast('Please enter email content to scan', 'warning');
                return;
            }
            
            setLoadingState(true);
            
            try {
                const response = await makeSecureRequest('/api/scan', {
                    method: 'POST',
                    data: {
                        text: emailContent,
                        use_llm_validation: document.getElementById('llmValidation').checked
                    }
                });
                
                displayResults(response.data);
                showToast('Email scanned successfully!', 'success');
                
                // Refresh history if on history tab
                if (AppState.currentTab === 'history') {
                    loadHistory();
                }
                
            } catch (error) {
                console.error('Scan error:', error);
                let errorMessage = 'Failed to scan email';
                
                if (error.response?.data?.error) {
                    errorMessage = error.response.data.error;
                } else if (error.request) {
                    errorMessage = 'Cannot connect to API. Check your settings.';
                } else {
                    errorMessage = error.message;
                }
                
                showToast(errorMessage, 'error');
                
            } finally {
                setLoadingState(false);
            }
        }

        function setLoadingState(loading) {
            AppState.isScanning = loading;
            const scanButton = document.getElementById('scanButton');
            const buttonText = scanButton.querySelector('.button-text');
            
            if (loading) {
                scanButton.classList.add('loading');
                scanButton.disabled = true;
                buttonText.textContent = 'Scanning...';
            } else {
                scanButton.classList.remove('loading');
                scanButton.disabled = false;
                buttonText.textContent = 'Scan Email';
            }
        }

        function displayResults(results) {
            AppState.lastResults = results;
            
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');
            
            // Determine classification
            const classification = results.classification || 'unknown';
            const confidence = Math.round((results.confidence || 0) * 100);
            const probabilities = results.probabilities || {};
            
            // Get badge class
            const badgeClass = {
                'legitimate': 'badge-legitimate',
                'spam': 'badge-spam',
                'phishing': 'badge-phishing'
            }[classification] || 'badge-legitimate';
            
            resultsContent.innerHTML = `
                <div class="classification-badge ${badgeClass}">
                    ${classification.toUpperCase()}
                </div>
                
                <div class="confidence-display">
                    <div class="confidence-label">Confidence: ${confidence}%</div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${confidence}%"></div>
                    </div>
                </div>
                
                <div class="probability-breakdown">
                    <div class="probability-item">
                        <div class="probability-label">Legitimate</div>
                        <div class="probability-value" style="color: var(--success);">
                            ${Math.round((probabilities.legitimate || 0) * 100)}%
                        </div>
                    </div>
                    <div class="probability-item">
                        <div class="probability-label">Spam</div>
                        <div class="probability-value" style="color: var(--warning);">
                            ${Math.round((probabilities.spam || 0) * 100)}%
                        </div>
                    </div>
                    <div class="probability-item">
                        <div class="probability-label">Phishing</div>
                        <div class="probability-value" style="color: var(--danger);">
                            ${Math.round((probabilities.phishing || 0) * 100)}%
                        </div>
                    </div>
                </div>
                
                ${results.explanation ? `
                    <div class="explanation">
                        <strong>AI Analysis:</strong><br>
                        ${escapeHtml(results.explanation)}
                    </div>
                ` : ''}
                
                ${
                    // Only show LLM validation if toggle is enabled and data exists
                    document.getElementById('llmValidation').checked && results.llm_validation ? `
                    <div class="explanation">
                        <strong>LLM Validation:</strong><br>
                        ${formatLlmValidation(results.llm_validation)}
                    </div>
                ` : ''
                }
            `;
            
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // LLM Validation Formatting
        function formatLlmValidation(llmValidation) {
            if (!llmValidation || typeof llmValidation !== 'object') {
                return 'No LLM validation data available';
            }
            
            if (!llmValidation.enabled) {
                const reason = llmValidation.reason || llmValidation.error || 'LLM validation disabled';
                return `Status: Disabled (${escapeHtml(reason)})`;
            }
            
            let output = `Status: Enabled<br>`;
            
            if (llmValidation.llm_classification) {
                output += `LLM Classification: <strong>${llmValidation.llm_classification.toUpperCase()}</strong><br>`;
            }
            
            if (llmValidation.llm_confidence) {
                output += `LLM Confidence: <strong>${Math.round(llmValidation.llm_confidence * 100)}%</strong><br>`;
            }
            
            if (llmValidation.agreement !== undefined) {
                const agreementText = llmValidation.agreement ? 'Yes ‚úÖ' : 'No ‚ùå';
                output += `Models Agree: <strong>${agreementText}</strong><br>`;
            }
            
            if (llmValidation.llm_reasoning) {
                output += `<br><em>LLM Reasoning:</em><br>${escapeHtml(llmValidation.llm_reasoning)}<br>`;
            }
            
            if (llmValidation.recommendation) {
                output += `<br><em>Recommendation:</em><br>${escapeHtml(llmValidation.recommendation)}`;
            }
            
            return output;
        }

        // History Management
        async function loadHistory() {
            if (!AppState.isAuthenticated) return;
            
            const historyList = document.getElementById('historyList');
            
            try {
                const response = await makeSecureRequest('/api/history?limit=50');
                AppState.history = response.data.history || [];
                
                if (AppState.history.length === 0) {
                    historyList.innerHTML = `
                        <div class="text-center p-4" style="color: var(--text-secondary);">
                            No scan history available. Start by scanning some emails!
                        </div>
                    `;
                    return;
                }
                
                displayHistory();
                
            } catch (error) {
                console.error('History loading error:', error);
                
                historyList.innerHTML = `
                    <div class="text-center p-4" style="color: var(--text-secondary);">
                        Failed to load history. Please try again.
                    </div>
                `;
            }
        }

        function displayHistory() {
            const historyList = document.getElementById('historyList');
            const filteredHistory = getFilteredHistory();
            
            historyList.innerHTML = filteredHistory.map(item => `
                <div class="history-item" onclick="toggleHistoryDetails(${item.id})">
                    <div class="history-header">
                        <div class="classification-badge ${getBadgeClass(item.classification)}">
                            ${item.classification.toUpperCase()}
                        </div>
                        <div class="history-date">
                            ${formatDate(item.timestamp)}
                        </div>
                    </div>
                    
                    <div class="history-preview">
                        ${escapeHtml(item.text)}
                    </div>
                    
                    <div class="history-details" id="details-${item.id}">
                        <div style="margin-bottom: 1rem;">
                            <strong>Confidence:</strong> ${Math.round(item.confidence * 100)}%
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>Full Email:</strong><br>
                            <pre style="white-space: pre-wrap; font-family: inherit; font-size: 0.875rem; background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem; overflow-x: auto;">${escapeHtml(item.full_text)}</pre>
                        </div>
                        
                        <button class="btn" onclick="event.stopPropagation(); deleteHistoryItem(${item.id})">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getFilteredHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const filter = document.getElementById('historyFilter').value;
            
            return AppState.history.filter(item => {
                const matchesSearch = !searchTerm || 
                    item.text.toLowerCase().includes(searchTerm) ||
                    item.full_text.toLowerCase().includes(searchTerm);
                
                const matchesFilter = filter === 'all' || item.classification === filter;
                
                return matchesSearch && matchesFilter;
            });
        }

        function filterHistory() {
            displayHistory();
        }

        function toggleHistoryDetails(id) {
            const item = document.querySelector(`#details-${id}`);
            const parent = item.closest('.history-item');
            
            if (parent.classList.contains('expanded')) {
                parent.classList.remove('expanded');
            } else {
                // Close all other expanded items
                document.querySelectorAll('.history-item.expanded').forEach(el => {
                    el.classList.remove('expanded');
                });
                parent.classList.add('expanded');
            }
        }

        async function deleteHistoryItem(id) {
            if (!confirm('Are you sure you want to delete this history item?')) {
                return;
            }
            
            try {
                await makeSecureRequest(`/api/scan/${id}`, { method: 'DELETE' });
                AppState.history = AppState.history.filter(item => item.id !== id);
                displayHistory();
                showToast('History item deleted', 'success');
                
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Failed to delete history item', 'error');
            }
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all scan history?')) {
                // This would require a backend endpoint to clear user's history
                // For now, show a message
                showToast('Contact admin to clear all history', 'info');
            }
        }

        function exportHistory() {
            if (AppState.history.length === 0) {
                showToast('No history to export', 'warning');
                return;
            }
            
            const exportData = {
                export_date: new Date().toISOString(),
                user_email: AppState.userEmail,
                total_scans: AppState.history.length,
                history: AppState.history
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `email-guardian-history-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('History exported successfully', 'success');
        }

        // Stats Management (simplified version - full implementation would include D3.js charts)
        async function loadStats() {
            if (!AppState.isAuthenticated) return;
            
            const statsContent = document.getElementById('statsContent');
            statsContent.innerHTML = '<div class="stats-loading">Loading analytics...</div>';

            try {
                const days = document.getElementById('statsPeriod').value;
                const response = await makeSecureRequest(`/api/stats?days=${days}`);

                AppState.statsData = response.data;
                displayStats(response.data);

            } catch (error) {
                console.error('Stats loading error:', error);
                showStatsError('Failed to load analytics');
            }
        }

        function displayStats(data) {
            const statsContent = document.getElementById('statsContent');

            if (!data || data.total_scans === 0) {
                statsContent.innerHTML = `
                    <div class="no-data">
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">No Data Available</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">Start scanning emails to see analytics here</div>
                    </div>
                `;
                return;
            }

            statsContent.innerHTML = `
                <div class="stats-grid">
                    <div class="metric-card total">
                        <div class="metric-value">${data.total_scans}</div>
                        <div class="metric-label">Total Scans</div>
                    </div>
                    <div class="metric-card legitimate">
                        <div class="metric-value">${data.classification_counts?.legitimate || 0}</div>
                        <div class="metric-label">Legitimate Emails</div>
                    </div>
                    <div class="metric-card spam">
                        <div class="metric-value">${data.classification_counts?.spam || 0}</div>
                        <div class="metric-label">Spam Detected</div>
                    </div>
                    <div class="metric-card phishing">
                        <div class="metric-value">${data.classification_counts?.phishing || 0}</div>
                        <div class="metric-label">Phishing Detected</div>
                    </div>
                </div>
            `;
        }

        function showStatsError(message) {
            const statsContent = document.getElementById('statsContent');
            statsContent.innerHTML = `
                <div class="no-data">
                    <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Unable to Load Analytics</div>
                    <div style="font-size: 0.9rem; opacity: 0.7;">${escapeHtml(message)}</div>
                </div>
            `;
        }

        // Settings Management
        function saveSettings(e) {
            e.preventDefault();
            
            const apiUrl = document.getElementById('apiUrl').value.trim();
            
            if (!apiUrl) {
                showToast('API URL is required', 'error');
                return;
            }
            
            AppState.apiUrl = apiUrl;
            localStorage.setItem('apiUrl', apiUrl);
            
            showToast('Settings saved successfully', 'success');
            checkApiStatus();
        }

        async function testConnection() {
            if (!AppState.apiUrl) {
                showToast('Please enter API URL first', 'warning');
                return;
            }
            
            try {
                const response = await axios.get(`${AppState.apiUrl}/health`, {
                    timeout: 10000
                });
                
                showToast('Connection successful!', 'success');
                updateSystemStatus(response.data);
                
            } catch (error) {
                console.error('Connection test failed:', error);
                showToast('Connection failed. Check your API URL.', 'error');
                updateSystemStatus(null);
            }
        }

        async function checkApiStatus() {
            if (!AppState.apiUrl) return;
            
            try {
                const response = await axios.get(`${AppState.apiUrl}/health`, {
                    timeout: 5000
                });
                
                updateApiStatus(true);
                updateSystemStatus(response.data);
                
            } catch (error) {
                updateApiStatus(false);
                updateSystemStatus(null);
            }
        }

        function updateApiStatus(online) {
            const statusElement = document.getElementById('apiStatus');
            const connectionStatus = document.getElementById('apiConnectionStatus');
            
            if (online) {
                statusElement.className = 'status-indicator online';
                statusElement.innerHTML = '<span class="status-dot"></span><span class="status-text">Online</span>';
                
                if (connectionStatus) {
                    connectionStatus.className = 'status-indicator online';
                    connectionStatus.innerHTML = '<span class="status-dot"></span>Online';
                }
                statusElement.innerHTML = '<span class="status-dot"></span><span class="status-text">Offline</span>';
                connectionStatus.className = 'status-indicator offline';
                connectionStatus.innerHTML = '<span class="status-dot"></span>Offline';
            }
        }

        function updateSystemStatus(healthData) {
            const modelStatus = document.getElementById('modelStatus');
            const llmStatus = document.getElementById('llmStatus');
            const systemStats = document.getElementById('systemStats');
            
            if (healthData) {
                // Update model status
                if (modelStatus) {
                    const isModelOnline = healthData.model_loaded === true;
                    modelStatus.className = `status-indicator ${isModelOnline ? 'online' : 'offline'}`;
                    modelStatus.innerHTML = `<span class="status-dot"></span>${isModelOnline ? 'Online' : 'Offline'}`;
                }
                
                // Update LLM status
                if (llmStatus) {
                    const isLlmOnline = healthData.groq_validator === true;
                    llmStatus.className = `status-indicator ${isLlmOnline ? 'online' : 'offline'}`;
                    llmStatus.innerHTML = `<span class="status-dot"></span>${isLlmOnline ? 'Online' : 'Offline'}`;
                    
                    if (isLlmOnline && healthData.groq_model && healthData.groq_model !== 'N/A') {
                        llmStatus.title = `Model: ${healthData.groq_model}`;
                    }
                }
                
                // Update stats
                if (systemStats) {
                    systemStats.innerHTML = `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 0.5rem;">System Information</h4>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                API Version: ${healthData.api_version || 'Unknown'}<br>
                                Model Handler: ${healthData.model_loaded ? 'Available' : 'Unavailable'}<br>
                                Multi-User: ${healthData.multi_user ? 'Enabled' : 'Disabled'}<br>
                                Authentication: ${healthData.authentication || 'Unknown'}<br>
                                Total Users: ${healthData.total_users || 'Unknown'}<br>
                                ${healthData.groq_model ? `Groq Model: ${healthData.groq_model}<br>` : ''}
                                Last Check: ${new Date().toLocaleTimeString()}
                            </div>
                        </div>
                    `;
                }
            } else {
                // Offline state
                if (modelStatus) {
                    modelStatus.className = 'status-indicator offline';
                    modelStatus.innerHTML = '<span class="status-dot"></span>Unknown';
                }
                
                if (llmStatus) {
                    llmStatus.className = 'status-indicator offline';
                    llmStatus.innerHTML = '<span class="status-dot"></span>Unknown';
                }
                
                if (systemStats) {
                    systemStats.innerHTML = `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                Unable to connect to API
                            </div>
                        </div>
                    `;
                }
            }
        }

        // File Handling
        function updateCharCount() {
            const input = document.getElementById('emailInput');
            const count = input.value.length;
            document.getElementById('charCount').textContent = count.toLocaleString();
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.target.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                loadFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                loadFile(e.target.files[0]);
            }
        }

        function loadFile(file) {
            if (!file.type.includes('text') && !file.name.endsWith('.eml')) {
                showToast('Please select a text or .eml file', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('emailInput').value = e.target.result;
                updateCharCount();
                showToast(`File "${file.name}" loaded successfully`, 'success');
            };
            reader.readAsText(file);
        }

        // Example Email Loading
        function loadExample(type) {
            const examples = {
                legitimate: `Dear Team,

I hope this message finds you well.

I wanted to share a brief update on our current progress. As of today, all key deliverables for Phase 1 have been completed, and the documentation has been finalized. I appreciate everyone's effort in meeting the deadlines and maintaining high standards throughout.

Looking ahead, we'll be shifting our focus to Phase 2, which involves testing and optimization. Please ensure your individual components are fully ready for integration by Friday. I'll be scheduling a quick team check-in this Thursday at 10:00 AM to go over the timeline and address any potential concerns.

If you have any blockers or require assistance, don't hesitate to reach out directly. Your continued collaboration is greatly appreciated.

Best regards,
Alex Johnson
Project Manager
Johnson & Taylor Consulting`,
                
                spam: `From: deals@amazingoffers.com
Subject: URGENT - 80% OFF Everything Must Go!

üéâ MASSIVE CLEARANCE SALE üéâ

We're offering you an EXCLUSIVE 80% discount on ALL products!

‚úÖ Electronics - 80% OFF
‚úÖ Fashion - 80% OFF  
‚úÖ Home & Garden - 80% OFF
‚úÖ Books & Media - 80% OFF

This is a LIMITED TIME offer that expires in 24 hours!

Click here to shop now: http://amazingoffers.com/sale

Don't miss out on these incredible savings!

Best deals,
The Amazing Offers Team`,
                
                phishing: `From: security@your-bank-security.com
Subject: URGENT: Suspicious Activity Detected

SECURITY ALERT

Dear Valued Customer,

We have detected suspicious activity on your account. For your protection, we have temporarily suspended your online banking access.

To restore your account immediately, please verify your information by clicking the link below:

VERIFY YOUR ACCOUNT NOW: http://secure-bank-verification.fake-site.com

You must complete verification within 24 hours or your account will be permanently closed.

If you do not recognize this activity, please contact us immediately.

Security Department
Customer Protection Services`
            };
            
            document.getElementById('emailInput').value = examples[type];
            updateCharCount();
            showToast(`Loaded ${type} email example`, 'info');
        }

        // Result Actions
        function copyResults() {
            if (!AppState.lastResults) {
                showToast('No results to copy', 'warning');
                return;
            }
            
            const results = AppState.lastResults;
            const text = `
Email Guardian Scan Results
==========================
Classification: ${results.classification.toUpperCase()}
Confidence: ${Math.round(results.confidence * 100)}%

Probabilities:
- Legitimate: ${Math.round((results.probabilities?.legitimate || 0) * 100)}%
- Spam: ${Math.round((results.probabilities?.spam || 0) * 100)}%
- Phishing: ${Math.round((results.probabilities?.phishing || 0) * 100)}%

${results.explanation ? `Analysis: ${results.explanation}` : ''}

Scanned on: ${new Date().toLocaleString()}
User: ${AppState.userEmail}
            `.trim();
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Results copied to clipboard', 'success');
            }).catch(() => {
                showToast('Failed to copy results', 'error');
            });
        }

        function exportResults() {
            if (!AppState.lastResults) {
                showToast('No results to export', 'warning');
                return;
            }
            
            const exportData = {
                timestamp: new Date().toISOString(),
                user_email: AppState.userEmail,
                text: document.getElementById('emailInput').value,
                results: AppState.lastResults
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `email-scan-result-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Results exported successfully', 'success');
        }

        // Theme Management
        function toggleTheme() {
            AppState.theme = AppState.theme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', AppState.theme);
            localStorage.setItem('theme', AppState.theme);
            
            const icon = document.querySelector('#themeToggle svg path');
            if (AppState.theme === 'dark') {
                icon.setAttribute('d', 'M12 3V1M12 23V21M4.22 4.22L5.64 5.64M18.36 18.36L19.78 19.78M1 12H3M21 12H23M4.22 19.78L5.64 18.36M18.36 5.64L19.78 4.22');
            } else {
                icon.setAttribute('d', 'M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z');
            }
        }

        // Toast Notifications
        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${escapeHtml(message)}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, duration);
        }

        // Utility Functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(isoString) {
            return new Date(isoString).toLocaleString();
        }

        function getBadgeClass(classification) {
            return {
                'legitimate': 'badge-legitimate',
                'spam': 'badge-spam',
                'phishing': 'badge-phishing'
            }[classification] || 'badge-legitimate';
        }

        // Event Listeners
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        document.getElementById('registerBtn').addEventListener('click', handleRegister);

        // Auto-check API status periodically (only when authenticated)
        setInterval(() => {
            if (AppState.isAuthenticated) {
                checkApiStatus();
            }
        }, 60000); // Check every minute

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                if (AppState.currentTab === 'scanner' && AppState.isAuthenticated) {
                    scanEmail();
                }
            }
        });
    </script>
</body>
</html>
